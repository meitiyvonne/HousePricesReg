# .circleci/config.yml

# CircleCI 設定檔版本
version: 2.1

# 預定義命令，用於重複使用的步驟
commands:
  # 安裝依賴項的步驟
  install_deps:
    steps:
      - run:
          name: Install Core Dependencies
          command: pip install -r packages/regression_model/requirements.txt
      # 安裝本地套件
      - run:
          name: Install Local Package in Editable Mode
          command: pip install -e packages/regression_model/

# 定義作業 (Job)
jobs:
  # ----------------------------------------------------
  # 1. 測試 (build_and_test) Job 
  # ----------------------------------------------------
  build_and_test:
    docker:
      - image: cimg/python:3.8.10 
    
    working_directory: ~/project

    steps:
      - checkout

      # 恢復 pip 緩存
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "packages/regression_model/requirements.txt" }}
            - v1-dependencies-

      # 執行依賴項安裝
      - install_deps

      # 儲存 pip 緩存
      - save_cache:
          paths:
            - ./venv
            - /usr/local/lib/python3.8/site-packages
          key: v1-dependencies-{{ checksum "packages/regression_model/requirements.txt" }}
      
      # 運行 Tox 測試
      - run:
          name: Run Tox Tests
          command: tox

  # ----------------------------------------------------
  # 2. 部署 (deploy) Job (已修正步驟結構，移除 when: manual)
  # ----------------------------------------------------
  deploy:
    docker:
      - image: cimg/python:3.8.10
    
    working_directory: ~/project

    steps:
      - checkout
      
      # 安裝部署工具
      - run:
          name: Install Deployment Tools
          command: |
            pip install setuptools wheel twine

      # 部署到 PyPI/Gemfury (注意：這裡移除了錯誤的 when: manual)
      - run:
          name: Deploy Package
          command: |
            python setup.py sdist bdist_wheel
            twine upload dist/* --non-interactive


# 定義工作流程 (Workflow)
workflows:
  version: 2
  build_test_and_deploy:
    jobs:
      # 測試 Job
      - build_and_test:
          filters:
            branches:
              only:
                - main
                - partie-8-deploiement-continu

      # 部署 Job (使用 type: approval 實現手動批准)
      - deploy:
          requires:
            - build_and_test # 測試必須成功
          type: approval # <--- 這是正確實現手動批准的方式
          filters:
            branches:
              # ignore: /.*/ # 忽略所有分支上的自動執行
              only:
                - main  # <--- 只在 main 分支的 Commit Push 時包含此 Job
            tags:
              # only: /v[0-9]+(\.[0-9]+)*([a-zA-Z0-9]+)*/ # 匹配版本標籤 (e.g., v0.0.4)
              ignore: /.*/  # <--- 忽略所有 Tag 觸發